name: Build Alpine Linux for Hi3798MV100 (ARMv7)

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-alpine.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-alpine:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. 基础配置（禁用Git交互+网络优化）
        run: |
          git config --global core.askpass ""
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          # 配置Alpine镜像源（加速下载）
          echo "https://mirrors.ustc.edu.cn/alpine/v3.20/main/" > /tmp/alpine.repo
          echo "https://mirrors.ustc.edu.cn/alpine/v3.20/community/" >> /tmp/alpine.repo

      - name: 2. 安装编译依赖（原生构建工具）
        run: |
          sudo apt update && sudo apt install -y \
            qemu-user-static binfmt-support debootstrap \
            xz-utils dosfstools parted curl wget \
            squashfs-tools genisoimage libssl-dev \
            build-essential kmod

      - name: 3. 下载Alpine官方构建工具（mkimage）
        run: |
          mkdir -p alpine-build && cd alpine-build
          # 从Alpine官方仓库下载mkimage脚本（ARMv7适配版）
          wget -O mkimage.sh https://raw.githubusercontent.com/alpinelinux/alpine-make-vm-image/master/alpine-make-vm-image \
            || wget -O mkimage.sh https://ghproxy.com/https://raw.githubusercontent.com/alpinelinux/alpine-make-vm-image/master/alpine-make-vm-image
          chmod +x mkimage.sh
          # 启用ARM架构模拟
          sudo update-binfmts --enable qemu-arm
          sudo systemctl restart binfmt-support

      - name: 4. 构建Hi3798MV100专用Alpine镜像（核心步骤）
        run: |
          cd alpine-build
          # 定义构建参数（适配Hi3798MV100 ARMv7）
          IMAGE_NAME="alpine-hi3798mv100.img"
          IMAGE_SIZE="2G"
          # 预装依赖：核心工具+海思适配驱动
          PACKAGES="linux-lts openssh-server busybox udev kmod ethtool wireless-tools \
                    dhcpcd5 wpa_supplicant nano"
          
          # 执行官方构建脚本，生成ARMv7镜像
          sudo ./mkimage.sh \
            --image-size "$IMAGE_SIZE" \
            --arch armhf \
            --repository "$(cat /tmp/alpine.repo)" \
            --packages "$PACKAGES" \
            --script-chroot \
            "$IMAGE_NAME" << 'EOF'
          # 镜像内初始化配置（适配Hi3798MV100）
          # 1. 设置root密码（默认：alpine123）
          echo "root:alpine123" | chpasswd
          # 2. 启用SSH服务
          rc-update add sshd default
          # 3. 配置网络（静态IP，适配Hi3798MV100机顶盒）
          cat > /etc/network/interfaces << 'NETCONF'
          auto lo
          iface lo inet loopback

          auto eth0
          iface eth0 inet static
              address 192.168.0.100
              netmask 255.255.255.0
              gateway 192.168.0.1
              dns-nameservers 8.8.8.8 114.114.114.114
          NETCONF
          # 4. 加载Hi3798MV100核心驱动（提前适配）
          echo "dwc2" >> /etc/modules
          echo "usb-storage" >> /etc/modules
          echo "rtl8188eu" >> /etc/modules  # 常见WIFI驱动
          # 5. 禁用不必要服务，降低资源占用
          rc-update del cron default
          rc-update del bluetooth default
          EOF

      - name: 5. 修复镜像权限（便于刷机）
        run: |
          cd alpine-build
          # 调整镜像分区格式（适配Hi3798MV100刷机）
          sudo parted -s "$IMAGE_NAME" mklabel msdos
          sudo parted -s "$IMAGE_NAME" mkpart primary ext4 1M 100%
          # 压缩镜像（减小体积）
          gzip -9 "$IMAGE_NAME" -c > "${IMAGE_NAME}.gz"

      - name: 6. 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: alpine-hi3798mv100-image
          path: |
            alpine-build/alpine-hi3798mv100.img
            alpine-build/alpine-hi3798mv100.img.gz
          if-no-files-found: error
          compression-level: 6
          overwrite: true
